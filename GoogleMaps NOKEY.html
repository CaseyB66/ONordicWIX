<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Testing WIX HTML</title>
    <style>
    #map {
      border-style: solid; 
      height: 90%;	
      width: 90%;
      position: relative;
      left: 0px;
      border: 3px solid #73AD21;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {height: 600px; width: 100%;
        margin: 0;
        padding: 0;
      }
  	</style>
  </head>
  <body onload="ready()">
    <script async="" defer="defer" src="https://maps.googleapis.com/maps/api/js?key=API_KEY&callback=initMap"></script>
    <script type="text/javascript">
      const mintrackpointdelta = 0.0001;
      var map;
      var polylinetrk=null;
      var pointarray = [];
      var initCtr={lat: 41.371089, lng: -111.902241}
      function initMap() {
        console.log("initmap")
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: initCtr,
          mapTypeId: "terrain",
        });
        var msg={
          "type":"init",
          "label":"ONordic",
          "value":initCtr
        };
        window.parent.postMessage(msg , "*");
      }
      
      window.onmessage = function(event){
          if (event.data && event.data.hasOwnProperty('type')) {
            console.log("map found event type "+event.data.type+"; value "+event.data.value[0]);
            if (event.data.type==="addloc"){
              var latLng = new google.maps.LatLng(event.data.value['lat'],event.data.value['lng']);
              var marker = new google.maps.Marker({
              position: latLng,
              title: event.data.label,
              label: event.data.label,
              map: map
              });
            }
            if (event.data.type==="addtrack"){
              parser = new DOMParser();
              xmlDoc = parser.parseFromString(event.data.value,"text/xml");
              if (pointarray.length>2)
                polylinetrk.setMap(null);
              pointarray = [];
              var trackpoints= xmlDoc.getElementsByTagName("trkpt");
              if(trackpoints.length == 0) {
                  console.log("addtrack returning with no trkpt")
                  return;
              }
              console.log("addtrack found "+trackpoints.length+" trkpts")

              var lastlon = parseFloat(trackpoints[0].getAttribute("lon"));
              var lastlat = parseFloat(trackpoints[0].getAttribute("lat"));
              console.log("addTrack lat/lon: "+lastlat+"/"+lastlon)
              var latlng = new google.maps.LatLng(lastlat,lastlon);
              pointarray.push(latlng);
              for(var i = 1; i < trackpoints.length; i++) {
                  var lon = parseFloat(trackpoints[i].getAttribute("lon"));
                  var lat = parseFloat(trackpoints[i].getAttribute("lat"));
                  console.log("addTrack lat/lon: "+lat+"/"+lon)
              
                  // Verify that this is far enough away from the last point to be used.
                  var latdiff = lat - lastlat;
                  var londiff = lon - lastlon;
                  if(Math.sqrt(latdiff*latdiff + londiff*londiff)
                          > mintrackpointdelta) {
                      lastlon = lon;
                      lastlat = lat;
                      latlng = new google.maps.LatLng(lat,lon);
                      pointarray.push({ lat: lat, lng: lon});
                  }
              }
              console.log("addTrack found "+pointarray.length+" points")
              polylinetrk = new google.maps.Polyline({
                  path: pointarray,
                  strokeColor: "#FF0000",
                  strokeWeight: 3,
                  title: event.data.label,
                  label: event.data.label
              });
              polylinetrk.setMap(map);
            var msg={
              "type":"addtrack",
              "label":"event.data.label",
              "value":pointarray.length
            };
            window.parent.postMessage(msg , "*");
            }

          }
          else {
            console.log("map received a generic message:");
            console.log(event.data);
          }
        };
      function ready(){
        var msg={
          "type":"ready",
          "label":"",
          "value":0
        };
        window.parent.postMessage(msg , "*");
      }
    </script>
    <div id="map"></div>
    
  </body>
</html>
